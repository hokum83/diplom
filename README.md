# Дипломная работа - `Гультяев Алексей`

## Общая информация
Для развёртывания инфраструктуры используется Terraform и Ansible. Необходимые зависимости определены в файле *requirements.yml*. Для запуска задачи развертывания и настройки необходимо:
1. установить *terraform* и *ansible*
2. установить интерфейс командной строки Yandex Cloud и настроить профиль согласно [инструкции](https://yandex.cloud/ru/docs/cli/quickstart)
3. клонировать репозитарий проекта, перейти в его директорию создать файл с переменными *terraform.tfvars* (см. пример *terraform.tfvars.example*), файл *meta.txt* (см. пример *meta.txt.example*) и *ansible.cfg* (см. пример *ansible.cfg.example*)
 и инициировать проект командой `terraform init`
4. запустить развертывание инфраструктуры командой `terraform apply`

И развертывание и настройка производится запуском одной команды, поэтому для удобства управления зависимостями конфигурация разделена на соответствующие модули.

### 1. Создание и конфигурирование сети
**Конфигурация определена в модуле *"modules/vpc"*.** Модуль развертывается первым, т.к. от него зависят все остальные. В результате выполнения создается:
1. сеть
2. две подсети в разных зонах доступности
3. NAT шлюз и соответствующее правило маршрутизации для выхода в интернет для машин без публичного NAT адреса
4. две группы безопасности с соответствующими правилами: *private_sg* для машин без прямого доступа из интернет и *public_sg* для машин, имеющих публичный адрес, а так же для балансировщика ALB.

### 2. Развертывание ВМ для сайта
**Конфигурация определена в модуле *"modules/web"*.** Модулем создаются две ВМ для сайта с помощью Instance Group в разных зонах доступности. Вместе с группой ВМ так же в этом модуле создаются балансировщик приложений, http-роутер, виртуальный хост, backend и target группа, listener, сервисный аккаунт с правами на создание групп ВМ. Настройки балансировщика выполнены согласно требованиям из задания, ВМ и балансировщик помещены в соответствущие заданию группы безопасности.
Дополнительно, ввиду отсутствия информации о дисках в выводе у ресурса yandex_compute_instance_group для дальнейшего использования в модуле создания снапшотов, пришлось использовать получение необходимых данных через источник данных (Data source).

### 3. Развертывание ВМ для логирования
**Конфигурация определена в модуле *"modules/elk"*.** Модулем создаются три ВМ для отдельного размещения каждого компонента: elasticsearch, logstash, kibana. ВМ помещены в соответствущие заданию группы безопасности.

### 4. Развертывание ВМ для мониторинга
**Конфигурация определена в модуле *"modules/zbx"*.** Модулем создаются две ВМ для отдельного размещения zabbix сервера и фронтенда, а также отказоустойчивый managed кластер PostgreSQL, база данных, пользователь и автоматически генерируемый пароль доступа. ВМ и кластер СУБД помещены в соответствущие заданию группы безопасности.

### 5. Развертывание jump хоста и запуск ansible
**Конфигурация определена в модуле *"modules/jump"*.** Модулем создается jump хост для установки ПО и настройки серверов с помощью плейбуков ansible. Для успешного запуска плейбуков запуск этого модуля зависит от выполнения предыдущих модулей.
Для динамического inventory используется самописный скрипт на bash *yc-inventory.sh*, который на основе меток *type:*, определенных в ресурсах для развертывания ВМ, определяет группы хостов в инвентори для применения соответствующих плейбуков. Так же плейбуки используют файл переменных *tf_ansible_vars_file.yml*, генерируемый автоматически на основе результатов выполнения модулей terraform.

Запуск плейбуков осуществляется в определенной последовательности:

#### 5.1 Запуск плейбука для настройки сайта
**Сценарий определен в плейбуке *"playbooks/web.yml"*.** В качестве плейбука для установки ПО, настройки сайта и копирования статических файлов использовался плейбук из соответствующего домашнего задания по ansible

#### 5.2 Запуск плейбука для настройки мониторинга
**Сценарий определен в плейбуке *"playbooks/zbx.yml"*.** Плейбук использует роли из коллекции community.zabbix и создан на основе документации коллекции. Плейбук разделен на несколько логических блоков, выполняемых последовательно:
1. Установка и настройка zabbix server и агента
2. Установка и настройка zabbix fronted
3. Установка и настройка zabbix агента для сервера, создание хоста в zabbix через API
4. Установка и настройка zabbix агентов для серверов nginx, создание хостов в zabbix через API
5. Установка и настройка zabbix агента для остальных, создание хостов в zabbix через API
6. Генерация файла json с конфигурацией дашборда и его создание в zabbix через API

#### 5.3 Запуск плейбука для настройки логирования
**Сценарий определен в плейбуке *"playbooks/elk.yml"*.** Плейбук изначально был основан на плейбуках, найденных на интернет, но в последствии практически полностью переписан самостоятельно. Плейбук разделен на несколько логических блоков, выполняемых последовательно:
1. Установка и настройка elasticsearch и metricbeat
2. Установка и настройка kibana и metricbeat
3. Установка и настройка logstash и metricbeat
4. Установка и настройка filebeat на серверы nginx

### 6. Настойка резервного копирования
**Конфигурация определена в модуле *"modules/snap"*.** Последним выполняется модуль создания еженедельного расписания и разового создания снапштов для всех ВМ. Данный модуль зависит от выполнения модуля ВМ для провижена, для того, чтобы снапшоты создались после завершения установки и настройки всех сервисов. Для выполнения данного модуля в переменную *disk_ids* собираются данные о дисках со всех модулей, развертывающих ВМ.

